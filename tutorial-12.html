<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<meta name="author" content="perihelion of poSTmortem">
<title>Of Controlling The Puppets</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<a href="." style="position: absolute; top: .5rem; left: .5rem;">Index</a>
<a href="https://github.com/nguillaumin/perihelion-m68k-tutorials"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>
<style>
.highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .cm {
  color: #999988;
  font-style: italic;
}
.highlight .cp {
  color: #999999;
  font-weight: bold;
}
.highlight .c1 {
  color: #999988;
  font-style: italic;
}
.highlight .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
.highlight .c, .highlight .cd {
  color: #999988;
  font-style: italic;
}
.highlight .err {
  color: #a61717;
  background-color: #e3d2d2;
}
.highlight .gd {
  color: #000000;
  background-color: #ffdddd;
}
.highlight .ge {
  color: #000000;
  font-style: italic;
}
.highlight .gr {
  color: #aa0000;
}
.highlight .gh {
  color: #999999;
}
.highlight .gi {
  color: #000000;
  background-color: #ddffdd;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
  font-weight: bold;
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .gt {
  color: #aa0000;
}
.highlight .kc {
  color: #000000;
  font-weight: bold;
}
.highlight .kd {
  color: #000000;
  font-weight: bold;
}
.highlight .kn {
  color: #000000;
  font-weight: bold;
}
.highlight .kp {
  color: #000000;
  font-weight: bold;
}
.highlight .kr {
  color: #000000;
  font-weight: bold;
}
.highlight .kt {
  color: #445588;
  font-weight: bold;
}
.highlight .k, .highlight .kv {
  color: #000000;
  font-weight: bold;
}
.highlight .mf {
  color: #009999;
}
.highlight .mh {
  color: #009999;
}
.highlight .il {
  color: #009999;
}
.highlight .mi {
  color: #009999;
}
.highlight .mo {
  color: #009999;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #009999;
}
.highlight .sb {
  color: #d14;
}
.highlight .sc {
  color: #d14;
}
.highlight .sd {
  color: #d14;
}
.highlight .s2 {
  color: #d14;
}
.highlight .se {
  color: #d14;
}
.highlight .sh {
  color: #d14;
}
.highlight .si {
  color: #d14;
}
.highlight .sx {
  color: #d14;
}
.highlight .sr {
  color: #009926;
}
.highlight .s1 {
  color: #d14;
}
.highlight .ss {
  color: #990073;
}
.highlight .s {
  color: #d14;
}
.highlight .na {
  color: #008080;
}
.highlight .bp {
  color: #999999;
}
.highlight .nb {
  color: #0086B3;
}
.highlight .nc {
  color: #445588;
  font-weight: bold;
}
.highlight .no {
  color: #008080;
}
.highlight .nd {
  color: #3c5d5d;
  font-weight: bold;
}
.highlight .ni {
  color: #800080;
}
.highlight .ne {
  color: #990000;
  font-weight: bold;
}
.highlight .nf {
  color: #990000;
  font-weight: bold;
}
.highlight .nl {
  color: #990000;
  font-weight: bold;
}
.highlight .nn {
  color: #555555;
}
.highlight .nt {
  color: #000080;
}
.highlight .vc {
  color: #008080;
}
.highlight .vg {
  color: #008080;
}
.highlight .vi {
  color: #008080;
}
.highlight .nv {
  color: #008080;
}
.highlight .ow {
  color: #000000;
  font-weight: bold;
}
.highlight .o {
  color: #000000;
  font-weight: bold;
}
.highlight .w {
  color: #bbbbbb;
}
.highlight {
  background-color: #f8f8f8;
}
</style>
</head>
<body class="article">
<div id="header">
<h1>Of Controlling The Puppets</h1>
<div class="details">
<span id="author" class="author">perihelion of poSTmortem</span><br>
<span id="revdate">2002-07-13 (last edition of the initial revision)</span>
</div>
</div>
<div id="content">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>I love the smell of napalm in the morning&#8230;&#8203; it smells like victory</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Apocalypse Now
</div>
</div>
<div class="paragraph">
<p>Yep, here we go again, this time I think we&#8217;ll have a nice little tutorial on our hands, not that
big. It only concerns the workings of the joystick. It could&#8217;ve involved the mouse as well, but
to be honest I haven&#8217;t gotten the workings of the mouse down yet. The code will build
heavily on the previous tutorial, since we are going to move a sprite around with the joystick,
but you don&#8217;t need to understand the sprite parts of the code to understand the workings of
the joystick. If you don&#8217;t know what a joystick is, or if you don&#8217;t recognise the little sprite ship
used in the sample source, you are not allowed to read further. Please stop this instant and
browse the web for more generally related Atari information.</p>
</div>
<div class="paragraph">
<p>A while back, I thought the ST was so much cooler than your average PC, because with the
ST, you just have to plug in a joystick and it works. With a PC, you have to install drivers and
shit, and configure the exact joystick and generally mess around lots and perhaps even then
it won&#8217;t work or the program you want to run doesn&#8217;t support your joystick. All in all inferior
construction, or so I thought. Actually, with the ST, you also need to set up your own joystick
driver. In fact, since you usually don&#8217;t have a hard drive and the OS (operating system)
doesn&#8217;t have drivers for the joystick, every program needs it&#8217;s own drivers for the joystick.
Writing the joystick driver isn&#8217;t at all difficult, but you have to have some working knowledge
to do it.</p>
</div>
<div class="paragraph">
<p>There is a little 6301 processor inside the Atari ST, which takes care of the keyboard, the
mouse and the joystick. It even has a real time clock. This cute little chip is sometimes
referred to as the IKBD, for <strong>I</strong>ntelligent <strong>K</strong>ey<strong>B</strong>oar<strong>D</strong>. It might be fun to know that the IKBD has
4K (4096 bytes) of ROM memory, and 128 bytes of RAM. ROM stands for <strong>R</strong>ead <strong>O</strong>nly <strong>M</strong>emory,
and as it says, it&#8217;s memory that can&#8217;t be altered, RAM is <strong>R</strong>andom <strong>A</strong>ccess <strong>M</strong>emory and it is that
which we usually mean by memory. The 128 bytes of RAM on the IKBD are only used as a
temporal storage area. The reason for having a separate chip altogether taking care of the
keyboard, mouse and joystick is that those actions won&#8217;t burden the main processor (the
68000, the one we&#8217;ve been programming so far in these tutorials). Instead, we can poll the
IKBD as we choose, or tell it to report stuff in any way we choose, and just let the IKBD
worry about the details.</p>
</div>
<div class="paragraph">
<p>Our mission therefore is clear: we must find a way to make the IKBD report the status of the
joystick, and also find a way to read that status in some way. When that is accomplished, we
can use the sprite routine from the previous tutorial as it is, with only a change in the
<code>move_sprite</code> subroutine. The new subroutine will update the X and Y coordinates in
accordance with the joystick status instead of just moving it about.</p>
</div>
<div class="paragraph">
<p>Trap function 25 of the XBIOS will allow us to send commands to the IKBD. However, unlike
other trap calls, the input data is a pointer to a string of data. <a href="appendixes/ikbd.txt">IKBD Protocol</a> may
seem very sketchy and difficult to understand, but it does contain a list of all the possible
commands that you can send to the IKBD, taking a look inside it, we see function <code>$14</code>. IKBD
command <code>$14</code> will report joystick status every time the joystick is changed. All well and good,
this is how we set it up.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-m68k" data-lang="m68k"><span id="L1" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">joy_on</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>           <span class="c1">; pointer to IKBD instructions</span></span>
<span id="L2" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>                <span class="c1">; instruction length - 1</span></span>
<span id="L3" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>               <span class="c1">; send instruction to IKBD</span></span>
<span id="L4" class="line">                <span class="k">trap</span>    <span class="nd">#</span><span class="mi">14</span></span>
<span id="L5" class="line">                <span class="k">addq</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">8</span><span class="p">,</span> <span class="nb">a7</span></span>
<span id="L6" class="line"></span>
<span id="L7" class="line"><span class="nl">joy_on</span>          <span class="kt">dc</span><span class="nd">.b </span>   <span class="mh">$14</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first parameter is a pointer to the address which contains the commands, the second
parameter is the length in bytes of the command list minus one, in this case zero. Then the
function number, a trap calling XBIOS and a normal stack clean up. Sure, so now the joystick
reports information, but where does the information go? Well, actually we need to write our
own routine to read the joystick information.</p>
</div>
<div class="paragraph">
<p>Every time the joystick sends information, there is a jump to an address with instructions of
what to do with this data, compare this with the timers from <a href="tutorial-09.html">tutorial 9</a>.
Also, as with the timers, we will hook up our own routine to read the joystick. With trap
function 34 of the XBIOS, the IKBD returns a list of all its vectors. The address of the IKBD
vectors is put in <code>d0</code>. The joystick report vector is at offset 24, so by putting our own
joystick routine at the address pointed to by <code>d0</code>+24, we have effectively hooked up our
own joystick routine.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-m68k" data-lang="m68k"><span id="L1" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">34</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span></span>
<span id="L2" class="line">                <span class="k">trap</span>    <span class="nd">#</span><span class="mi">14</span></span>
<span id="L3" class="line">                <span class="k">addq</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">2</span><span class="p">,</span> <span class="nb">a7</span>                   <span class="c1">; return IKBD vector table</span></span>
<span id="L4" class="line"></span>
<span id="L5" class="line">                <span class="k">move</span><span class="nd">.l </span><span class="nb">d0</span><span class="p">,</span> <span class="nv">ikbd_vec</span>              <span class="c1">; store IKBD vectors address</span></span>
<span id="L6" class="line">                <span class="k">move</span><span class="nd">.l </span><span class="nb">d0</span><span class="p">,</span> <span class="nb">a0</span>                    <span class="c1">; a0 points to IKBD vectors</span></span>
<span id="L7" class="line">                <span class="k">move</span><span class="nd">.l </span><span class="mi">24</span><span class="p">(</span><span class="nb">a0</span><span class="p">),</span> <span class="nv">old_joy</span>           <span class="c1">; backup old joystick vector</span></span>
<span id="L8" class="line">                <span class="k">move</span><span class="nd">.l #</span><span class="nv">read_joy</span><span class="p">,</span> <span class="mi">24</span><span class="p">(</span><span class="nb">a0</span><span class="p">)</span>         <span class="c1">; input our joystick vector</span></span>
<span id="L9" class="line"></span>
<span id="L10" class="line"><span class="nl">read_joy</span></span>
<span id="L11" class="line">                <span class="k">nop</span>                              <span class="c1">; so far, we don't know what to do</span></span>
<span id="L12" class="line">                <span class="k">rts</span>                              <span class="c1">; note, rts, not rte</span></span>
<span id="L13" class="line"></span>
<span id="L14" class="line"><span class="nl">dc</span><span class="nd">.l </span>           <span class="nv">ikbd_vec</span>                         <span class="c1">; old IKBD vector storage</span></span>
<span id="L15" class="line"><span class="nl">dc</span><span class="nd">.l </span>           <span class="nv">old_joy</span>                          <span class="err">;</span> <span class="nv">old</span> <span class="nv">joy</span> <span class="nv">vector</span> <span class="nv">storage</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Straightforward, first get the address of the IKBD vectors. Store it for future restoration. Then
put the address in a0 so that a0 points to the IKBD vectors, backup the old joystick vector
which is found at offset 24, and input our own joystick routine. By the way, the mouse vector
is at offset 16. With the help of this and the information given on the other IKBD commands
on appendices/ikbd.txt[IKBD Protocol], you should be able to setup your own mouse routine as well.</p>
</div>
<div class="paragraph">
<p>The joystick routine ends with an rts, nothing else, and may not take more than 1/100 of a
second (half a VBL, more than enough time really). What happens now is that each time the
joystick status is changed, the ST will jump to our joystick routine. Once there, <code>a0</code> will point
to three bytes in memory which contain the status of the joysticks.</p>
</div>
<div class="paragraph">
<p>The first of these bytes is a header telling us which joystick it was that did something. The
byte will contain <code>$FE</code> if joystick 0 did something, and <code>$FF</code> if it was joystick 1 (meaning the last
bit represents either joystick 0 or joystick 1). Remember, joystick 0 is the joystick port shared
with the mouse, and joystick 1 is the port exclusively for joysticks. The next two bytes
contain the actual information for the joysticks. The first one holds status for joystick 0, and
the other one for joystick 1. The data has this structure</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">F</th>
<th class="tableblock halign-center valign-top">0</th>
<th class="tableblock halign-center valign-top">0</th>
<th class="tableblock halign-center valign-top">0</th>
<th class="tableblock halign-center valign-top">R</th>
<th class="tableblock halign-center valign-top">L</th>
<th class="tableblock halign-center valign-top">D</th>
<th class="tableblock halign-center valign-top">U</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" colspan="8"><p class="tableblock">(F = fire, R = right, L = left, D = down, U = up)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>So if bit 7 is set, the fire button was pressed, if bit 0 is set, the joystick is moved up, if bit 0,
2 and 7 are set, the joystick is moved up-right while the fire button is being pressed. Real
simple. Here&#8217;s a joystick routine that will simply store the joystick data in memory, two
different variables could have been used instead of course (but this is good practice on
addressing modes).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-m68k" data-lang="m68k"><span id="L1" class="line"><span class="nl">read_joy</span></span>
<span id="L2" class="line"><span class="c1">; executes every time joystick information is changed</span></span>
<span id="L3" class="line">                <span class="k">move</span><span class="nd">.b </span> <span class="mi">1</span><span class="p">(</span><span class="nb">a0</span><span class="p">),</span> <span class="nv">joy</span>               <span class="c1">; store joy 0 data</span></span>
<span id="L4" class="line">                <span class="k">move</span><span class="nd">.b </span> <span class="mi">2</span><span class="p">(</span><span class="nb">a0</span><span class="p">),</span> <span class="nv">joy</span><span class="o">+</span><span class="mi">1</span>             <span class="c1">; store joy 1 data</span></span>
<span id="L5" class="line">                <span class="k">rts</span></span>
<span id="L6" class="line"></span>
<span id="L7" class="line"><span class="nl">joy</span>             <span class="kt">ds</span><span class="nd">.b </span><span class="mi">2</span>                           <span class="err">;</span> <span class="nv">storage</span> <span class="nv">for</span> <span class="nv">joystick</span> <span class="nv">data</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s it! Well, almost. We must restore our poor system, for one thing, it would be good to
turn the mouse back on :) When we turn on the joystick, the mouse is turned off. In order to
turn it on, we send command <code>$08</code> to the IKBD, to put the mouse in relative report mode,
which would probably be the default mode for the mouse then. While we&#8217;re at it, might be
good to restore the joystick vector as well. For the curious lot out there, "mus" is Swedish for
mouse, and it&#8217;s a suitable short form for mouse as well.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-m68k" data-lang="m68k"><span id="L1" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">mus_on</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>           <span class="c1">; pointer to IKBD instruction</span></span>
<span id="L2" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>                <span class="c1">; length of instruction - 1</span></span>
<span id="L3" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>               <span class="c1">; send instruction to IKBD</span></span>
<span id="L4" class="line">                <span class="k">trap</span>    <span class="nd">#</span><span class="mi">14</span></span>
<span id="L5" class="line">                <span class="k">addq</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">8</span><span class="p">,</span> <span class="nb">a7</span></span>
<span id="L6" class="line"></span>
<span id="L7" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nv">ikbd_vec</span><span class="p">,</span> <span class="nb">a0</span>             <span class="c1">; a0 points to old IKBD vectors</span></span>
<span id="L8" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nv">old_joy</span><span class="p">,</span> <span class="mi">24</span><span class="p">(</span><span class="nb">a0</span><span class="p">)</span>          <span class="c1">; restore joystick vector</span></span>
<span id="L9" class="line"></span>
<span id="L10" class="line"><span class="nl">mus_on</span>          <span class="kt">dc</span><span class="nd">.b </span>   <span class="mh">$08</span></span>
<span id="L11" class="line"><span class="nl">ikbd_vec</span>        <span class="kt">ds</span><span class="nd">.l </span>   <span class="mi">1</span> <span class="nv">IKBD</span> <span class="nv">vector</span> <span class="nv">storage</span></span>
<span id="L12" class="line"><span class="nl">old_joy</span>         <span class="kt">ds</span><span class="nd">.l </span>   <span class="mi">1</span> <span class="nv">old</span> <span class="nv">joy</span> <span class="nv">vector</span> <span class="nv">storage</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Two other commands of the IKBD that might be good to know about are <code>$1A</code>, which turns off
the joystick, and <code>$12</code> which turns off the mouse. Let&#8217;s say we want to be on the really safe
side and not only turn on joystick reporting but also turn off mouse reporting, it would look
thusly</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-m68k" data-lang="m68k"><span id="L1" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">joy_on</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>           <span class="c1">; pointer to IKBD instructions</span></span>
<span id="L2" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>                <span class="c1">; instruction length - 1</span></span>
<span id="L3" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>               <span class="c1">; send instruction to IKBD</span></span>
<span id="L4" class="line">                <span class="k">trap</span>    <span class="nd">#</span><span class="mi">14</span></span>
<span id="L5" class="line">                <span class="k">addq</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">8</span><span class="p">,</span> <span class="nb">a7</span></span>
<span id="L6" class="line"></span>
<span id="L7" class="line"><span class="nl">joy_on</span>          <span class="kt">dc</span><span class="nd">.b </span>   <span class="mh">$14</span><span class="p">,</span> <span class="mh">$12</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note how the extra parameters are just appended to the command list, and the update of the
instruction length parameter to reflect the new command list length. Here comes the source
of the program, hold on!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-m68k" data-lang="m68k"><span id="L1" class="line">                <span class="k">jsr</span>     <span class="nv">initialise</span></span>
<span id="L2" class="line"></span>
<span id="L3" class="line"><span class="c1">; pre-shifting sprite</span></span>
<span id="L4" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">spr_dat</span><span class="p">,</span> <span class="nb">a0</span>              <span class="c1">; original sprite data</span></span>
<span id="L5" class="line">                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">34</span><span class="p">,</span> <span class="nb">a0</span>                   <span class="c1">; skip palette</span></span>
<span id="L6" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">sprite</span><span class="p">,</span> <span class="nb">a1</span>               <span class="c1">; storage of pre-shifted sprite</span></span>
<span id="L7" class="line"></span>
<span id="L8" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">32</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d0</span>                 <span class="c1">; 32 scan lines per sprite</span></span>
<span id="L9" class="line"><span class="nl">first_sprite</span></span>
<span id="L10" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>              <span class="c1">; move from original to pre-shifted</span></span>
<span id="L11" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span></span>
<span id="L12" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span></span>
<span id="L13" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>              <span class="c1">; 32 pixels moved</span></span>
<span id="L14" class="line">                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">8</span><span class="p">,</span> <span class="nb">a1</span>                    <span class="c1">; jump over end words</span></span>
<span id="L15" class="line">                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">144</span><span class="p">,</span> <span class="nb">a0</span>                  <span class="c1">; jump to next scan line</span></span>
<span id="L16" class="line">                <span class="k">dbf</span>     <span class="nb">d0</span><span class="p">,</span> <span class="nv">first_sprite</span></span>
<span id="L17" class="line"><span class="c1">; the picture sprite has been copied to first position in pre-shift</span></span>
<span id="L18" class="line"></span>
<span id="L19" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">sprite</span><span class="p">,</span> <span class="nb">a0</span>               <span class="c1">; point to beginning of storage area</span></span>
<span id="L20" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">sprite</span><span class="p">,</span> <span class="nb">a1</span>               <span class="c1">; point to beginning of storage area</span></span>
<span id="L21" class="line">                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">768</span><span class="p">,</span> <span class="nb">a1</span>                  <span class="c1">; point to next sprite position</span></span>
<span id="L22" class="line"></span>
<span id="L23" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">15</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d1</span>                 <span class="c1">; 15 sprite positions left</span></span>
<span id="L24" class="line"><span class="nl">positions</span></span>
<span id="L25" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">32</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d2</span>                 <span class="c1">; 32 scan lines per sprite</span></span>
<span id="L26" class="line"><span class="nl">line</span></span>
<span id="L27" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">4</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d3</span>                  <span class="c1">; 4 bit planes</span></span>
<span id="L28" class="line"><span class="nl">plane</span></span>
<span id="L29" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="p">(</span><span class="nb">a0</span><span class="p">),</span> <span class="nb">d0</span>                  <span class="c1">; move one word</span></span>
<span id="L30" class="line">                <span class="k">roxr</span>    <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; pre-shift</span></span>
<span id="L31" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nb">d0</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span>                  <span class="c1">; put it in place</span></span>
<span id="L32" class="line"></span>
<span id="L33" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="mi">8</span><span class="p">(</span><span class="nb">a0</span><span class="p">),</span> <span class="nb">d0</span>                 <span class="c1">; move one word</span></span>
<span id="L34" class="line">                <span class="k">roxr</span>    <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; pre-shift</span></span>
<span id="L35" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nb">d0</span><span class="p">,</span> <span class="mi">8</span><span class="p">(</span><span class="nb">a1</span><span class="p">)</span>                 <span class="c1">; put it in place</span></span>
<span id="L36" class="line"></span>
<span id="L37" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="mi">16</span><span class="p">(</span><span class="nb">a0</span><span class="p">),</span> <span class="nb">d0</span>                <span class="c1">; move one word</span></span>
<span id="L38" class="line">                <span class="k">roxr</span>    <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; pre-shift</span></span>
<span id="L39" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nb">d0</span><span class="p">,</span> <span class="mi">16</span><span class="p">(</span><span class="nb">a1</span><span class="p">)</span>                <span class="c1">; put it in place</span></span>
<span id="L40" class="line"></span>
<span id="L41" class="line">                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">2</span><span class="p">,</span> <span class="nb">a0</span>                    <span class="c1">; next bit plane, also clears X flag</span></span>
<span id="L42" class="line">                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">2</span><span class="p">,</span> <span class="nb">a1</span>                    <span class="c1">; next bit plane</span></span>
<span id="L43" class="line"></span>
<span id="L44" class="line">                <span class="k">dbf</span>     <span class="nb">d3</span><span class="p">,</span> <span class="nv">plane</span></span>
<span id="L45" class="line"></span>
<span id="L46" class="line">                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">16</span><span class="p">,</span> <span class="nb">a1</span>                   <span class="c1">; next scan line</span></span>
<span id="L47" class="line">                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">16</span><span class="p">,</span> <span class="nb">a0</span>                   <span class="c1">; next scan line</span></span>
<span id="L48" class="line"></span>
<span id="L49" class="line">                <span class="k">dbf</span>     <span class="nb">d2</span><span class="p">,</span> <span class="nv">line</span></span>
<span id="L50" class="line"></span>
<span id="L51" class="line">                <span class="k">dbf</span>     <span class="nb">d1</span><span class="p">,</span> <span class="nv">positions</span></span>
<span id="L52" class="line"><span class="c1">; pre-shift of sprite done, all 16 sprite positions saved in sprite</span></span>
<span id="L53" class="line"></span>
<span id="L54" class="line"></span>
<span id="L55" class="line"><span class="c1">; pre-shifting mask</span></span>
<span id="L56" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">spr_dat</span><span class="p">,</span> <span class="nb">a0</span></span>
<span id="L57" class="line">                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">34</span><span class="o">+</span><span class="mi">160</span><span class="o">*</span><span class="mi">32</span><span class="p">,</span> <span class="nb">a0</span>            <span class="c1">; skip palette and sprite</span></span>
<span id="L58" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">mask</span><span class="p">,</span> <span class="nb">a1</span>                 <span class="c1">; load up mask part</span></span>
<span id="L59" class="line"></span>
<span id="L60" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">32</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d0</span>                 <span class="c1">; 32 scan lines per sprite</span></span>
<span id="L61" class="line"><span class="nl">first_mask</span></span>
<span id="L62" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span>               <span class="c1">; move from original to pre-shifted</span></span>
<span id="L63" class="line">                <span class="k">not</span><span class="nd">.l </span>  <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>                     <span class="c1">; invert the mask data</span></span>
<span id="L64" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span></span>
<span id="L65" class="line">                <span class="k">not</span><span class="nd">.l </span>  <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>                     <span class="c1">; invert the mask data</span></span>
<span id="L66" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span></span>
<span id="L67" class="line">                <span class="k">not</span><span class="nd">.l </span>  <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>                     <span class="c1">; invert the mask data</span></span>
<span id="L68" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span></span>
<span id="L69" class="line">                <span class="k">not</span><span class="nd">.l </span>  <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>                     <span class="c1">; invert the mask data</span></span>
<span id="L70" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mh">$ffffffff</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>         <span class="c1">; fill last two words...</span></span>
<span id="L71" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mh">$ffffffff</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>         <span class="c1">; ... with all 1's</span></span>
<span id="L72" class="line"></span>
<span id="L73" class="line">                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">144</span><span class="p">,</span> <span class="nb">a0</span>                  <span class="c1">; jump to next scan line</span></span>
<span id="L74" class="line">                <span class="k">dbf</span>     <span class="nb">d0</span><span class="p">,</span> <span class="nv">first_mask</span></span>
<span id="L75" class="line"><span class="c1">; the picture mask has been copied to first position in pre-shift</span></span>
<span id="L76" class="line"></span>
<span id="L77" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">mask</span><span class="p">,</span> <span class="nb">a0</span>                 <span class="c1">; point to beginning of storage area</span></span>
<span id="L78" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">mask</span><span class="p">,</span> <span class="nb">a1</span>                 <span class="c1">; point to beginning of storage area</span></span>
<span id="L79" class="line">                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">768</span><span class="p">,</span> <span class="nb">a1</span>                  <span class="c1">; point to next mask position</span></span>
<span id="L80" class="line"></span>
<span id="L81" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">15</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d1</span>                 <span class="c1">; 15 sprite positions left</span></span>
<span id="L82" class="line"><span class="nl">positions_mask</span></span>
<span id="L83" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">32</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d2</span>                 <span class="c1">; 32 scan lines per sprite</span></span>
<span id="L84" class="line"><span class="nl">line_mask</span></span>
<span id="L85" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">4</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d3</span>                  <span class="c1">; 4 bit planes</span></span>
<span id="L86" class="line"><span class="nl">plane_mask</span></span>
<span id="L87" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="p">(</span><span class="nb">a0</span><span class="p">),</span> <span class="nb">d0</span>                  <span class="c1">; move one word</span></span>
<span id="L88" class="line">                <span class="k">roxr</span>    <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; pre-shift</span></span>
<span id="L89" class="line">                <span class="k">or</span><span class="nd">.w </span>   <span class="nd">#</span><span class="mb">%1000000000000000</span><span class="p">,</span> <span class="nb">d0</span>    <span class="c1">; make sure most significant bit set</span></span>
<span id="L90" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nb">d0</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span>                  <span class="c1">; put it in place</span></span>
<span id="L91" class="line"></span>
<span id="L92" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="mi">8</span><span class="p">(</span><span class="nb">a0</span><span class="p">),</span> <span class="nb">d0</span>                 <span class="c1">; move one word</span></span>
<span id="L93" class="line">                <span class="k">roxr</span>    <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; pre-shift</span></span>
<span id="L94" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nb">d0</span><span class="p">,</span> <span class="mi">8</span><span class="p">(</span><span class="nb">a1</span><span class="p">)</span>                 <span class="c1">; put it in place</span></span>
<span id="L95" class="line"></span>
<span id="L96" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="mi">16</span><span class="p">(</span><span class="nb">a0</span><span class="p">),</span> <span class="nb">d0</span>                <span class="c1">; move one word</span></span>
<span id="L97" class="line">                <span class="k">roxr</span>    <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; pre-shift</span></span>
<span id="L98" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nb">d0</span><span class="p">,</span> <span class="mi">16</span><span class="p">(</span><span class="nb">a1</span><span class="p">)</span>                <span class="c1">; put it in place</span></span>
<span id="L99" class="line"></span>
<span id="L100" class="line">                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">2</span><span class="p">,</span> <span class="nb">a1</span>                    <span class="c1">; next bit plane</span></span>
<span id="L101" class="line">                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">2</span><span class="p">,</span> <span class="nb">a0</span>                    <span class="c1">; next plane, clears X flag (bad)</span></span>
<span id="L102" class="line"></span>
<span id="L103" class="line">                <span class="k">dbf</span>     <span class="nb">d3</span><span class="p">,</span> <span class="nv">plane_mask</span></span>
<span id="L104" class="line"></span>
<span id="L105" class="line">                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">16</span><span class="p">,</span> <span class="nb">a1</span>                   <span class="c1">; next scan line</span></span>
<span id="L106" class="line">                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">16</span><span class="p">,</span> <span class="nb">a0</span>                   <span class="c1">; next scan line</span></span>
<span id="L107" class="line"></span>
<span id="L108" class="line">                <span class="k">dbf</span>     <span class="nb">d2</span><span class="p">,</span> <span class="nv">line_mask</span></span>
<span id="L109" class="line"></span>
<span id="L110" class="line">                <span class="k">dbf</span>     <span class="nb">d1</span><span class="p">,</span> <span class="nv">positions_mask</span></span>
<span id="L111" class="line"><span class="c1">; pre-shift of mask done, all 16 sprite positions saved in mask</span></span>
<span id="L112" class="line"></span>
<span id="L113" class="line"></span>
<span id="L114" class="line">                <span class="k">movem</span><span class="nd">.l </span><span class="nv">bg</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="nb">d0</span><span class="o">-</span><span class="nb">d7</span></span>
<span id="L115" class="line">                <span class="k">movem</span><span class="nd">.l </span><span class="nb">d0</span><span class="o">-</span><span class="nb">d7</span><span class="p">,</span> <span class="mh">$ff8240</span></span>
<span id="L116" class="line"></span>
<span id="L117" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">bg</span><span class="o">+</span><span class="mi">34</span><span class="p">,</span> <span class="nb">a0</span>                <span class="c1">; pixel part of background</span></span>
<span id="L118" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="mh">$44e</span><span class="p">,</span> <span class="nb">a1</span>                  <span class="c1">; put screen memory in a1</span></span>
<span id="L119" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">7999</span><span class="p">,</span> <span class="nb">d0</span>                 <span class="c1">; 8000 longwords to a screen</span></span>
<span id="L120" class="line"><span class="nl">pic_loop</span></span>
<span id="L121" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>              <span class="c1">; move one longword to screen</span></span>
<span id="L122" class="line">                <span class="k">dbf</span>     <span class="nb">d0</span><span class="p">,</span> <span class="nv">pic_loop</span>              <span class="c1">; background painted</span></span>
<span id="L123" class="line"></span>
<span id="L124" class="line">                <span class="k">jsr</span>     <span class="nv">save_background</span>           <span class="c1">; something in restore buffer</span></span>
<span id="L125" class="line"></span>
<span id="L126" class="line"></span>
<span id="L127" class="line"><span class="c1">; joy code</span></span>
<span id="L128" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">34</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span></span>
<span id="L129" class="line">                <span class="k">trap</span>    <span class="nd">#</span><span class="mi">14</span></span>
<span id="L130" class="line">                <span class="k">addq</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">2</span><span class="p">,</span> <span class="nb">a7</span>                    <span class="c1">; return IKBD vector table</span></span>
<span id="L131" class="line"></span>
<span id="L132" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nb">d0</span><span class="p">,</span> <span class="nv">ikbd_vec</span>              <span class="c1">; store IKBD vectors address</span></span>
<span id="L133" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nb">d0</span><span class="p">,</span> <span class="nb">a0</span>                    <span class="c1">; a0 points to IKBD vectors</span></span>
<span id="L134" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="mi">24</span><span class="p">(</span><span class="nb">a0</span><span class="p">),</span> <span class="nv">old_joy</span>           <span class="c1">; backup old joystick vector</span></span>
<span id="L135" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">read_joy</span><span class="p">,</span> <span class="mi">24</span><span class="p">(</span><span class="nb">a0</span><span class="p">)</span>         <span class="c1">; input my joystick vector</span></span>
<span id="L136" class="line"></span>
<span id="L137" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">joy_on</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>            <span class="c1">; pointer to IKBD instructions</span></span>
<span id="L138" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>                 <span class="c1">; instruction length - 1</span></span>
<span id="L139" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>                <span class="c1">; send instruction to IKBD</span></span>
<span id="L140" class="line">                <span class="k">trap</span>    <span class="nd">#</span><span class="mi">14</span></span>
<span id="L141" class="line">                <span class="k">addq</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">8</span><span class="p">,</span> <span class="nb">a7</span></span>
<span id="L142" class="line"><span class="c1">; end joystick init</span></span>
<span id="L143" class="line"></span>
<span id="L144" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="mh">$70</span><span class="p">,</span> <span class="nv">old_70</span>               <span class="c1">; backup $70</span></span>
<span id="L145" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="kr">main</span><span class="p">,</span> <span class="mh">$70</span>                <span class="c1">; put in main routine</span></span>
<span id="L146" class="line"></span>
<span id="L147" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span></span>
<span id="L148" class="line">                <span class="k">trap</span>    <span class="nd">#</span><span class="mi">1</span></span>
<span id="L149" class="line">                <span class="k">addq</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">2</span><span class="p">,</span> <span class="nb">a7</span>                    <span class="c1">; wait keypress</span></span>
<span id="L150" class="line"></span>
<span id="L151" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nv">old_70</span><span class="p">,</span> <span class="mh">$70</span>               <span class="c1">; restore old $70</span></span>
<span id="L152" class="line"></span>
<span id="L153" class="line"><span class="c1">; joy code</span></span>
<span id="L154" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">mus_on</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>            <span class="c1">; pointer to IKBD instruction</span></span>
<span id="L155" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>                 <span class="c1">; length of instruction - 1</span></span>
<span id="L156" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>                <span class="c1">; send instruction to IKBD</span></span>
<span id="L157" class="line">                <span class="k">trap</span>    <span class="nd">#</span><span class="mi">14</span></span>
<span id="L158" class="line">                <span class="k">addq</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">8</span><span class="p">,</span> <span class="nb">a7</span></span>
<span id="L159" class="line"></span>
<span id="L160" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nv">ikbd_vec</span><span class="p">,</span> <span class="nb">a0</span>              <span class="c1">; a0 points to old IKBD vectors</span></span>
<span id="L161" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nv">old_joy</span><span class="p">,</span> <span class="mi">24</span><span class="p">(</span><span class="nb">a0</span><span class="p">)</span>           <span class="c1">; restore joystick vector</span></span>
<span id="L162" class="line"><span class="c1">; end shut down</span></span>
<span id="L163" class="line"></span>
<span id="L164" class="line"></span>
<span id="L165" class="line">                <span class="k">jsr</span>     <span class="nv">restore</span></span>
<span id="L166" class="line"></span>
<span id="L167" class="line">                <span class="k">clr</span><span class="nd">.l </span>  <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span></span>
<span id="L168" class="line">                <span class="k">trap</span>    <span class="nd">#</span><span class="mi">1</span>                        <span class="c1">; exit</span></span>
<span id="L169" class="line"></span>
<span id="L170" class="line"><span class="nl">main</span></span>
<span id="L171" class="line">                <span class="k">movem</span><span class="nd">.l </span><span class="nb">d0</span><span class="o">-</span><span class="nb">d7</span><span class="o">/</span><span class="nb">a0</span><span class="o">-</span><span class="nb">a6</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span>        <span class="c1">; backup registers</span></span>
<span id="L172" class="line"></span>
<span id="L173" class="line">                <span class="k">jsr</span>     <span class="nv">restore_background</span></span>
<span id="L174" class="line">                <span class="k">jsr</span>     <span class="nv">move_sprite</span></span>
<span id="L175" class="line">                <span class="k">jsr</span>     <span class="nv">save_background</span></span>
<span id="L176" class="line">                <span class="k">jsr</span>     <span class="nv">apply_mask</span></span>
<span id="L177" class="line">                <span class="k">jsr</span>     <span class="nv">put_sprite</span></span>
<span id="L178" class="line"></span>
<span id="L179" class="line">                <span class="k">movem</span><span class="nd">.l </span><span class="p">(</span><span class="nb">a7</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="nb">d0</span><span class="o">-</span><span class="nb">d7</span><span class="o">/</span><span class="nb">a0</span><span class="o">-</span><span class="nb">a6</span>        <span class="c1">; restore registers</span></span>
<span id="L180" class="line"></span>
<span id="L181" class="line">                <span class="nv">rte</span></span>
<span id="L182" class="line"></span>
<span id="L183" class="line"><span class="nl">move_sprite</span></span>
<span id="L184" class="line"><span class="c1">; updates x and y coordinates according to joystick 1</span></span>
<span id="L185" class="line"><span class="c1">; if fire button pressed, add 1 to colour 0</span></span>
<span id="L186" class="line">                <span class="k">move</span><span class="nd">.b </span> <span class="nv">joy</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d0</span>                 <span class="c1">; check joystick 1</span></span>
<span id="L187" class="line"></span>
<span id="L188" class="line">                <span class="k">cmp</span>     <span class="nd">#</span><span class="mi">128</span><span class="p">,</span> <span class="nb">d0</span>                  <span class="c1">; fire</span></span>
<span id="L189" class="line">                <span class="k">blt</span>     <span class="nv">no_fire</span></span>
<span id="L190" class="line">                <span class="k">add</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mh">$001</span><span class="p">,</span> <span class="mh">$ff8240</span></span>
<span id="L191" class="line">                <span class="k">and</span><span class="nd">.b </span>  <span class="nd">#</span><span class="mb">%01111111</span><span class="p">,</span> <span class="nb">d0</span>            <span class="c1">; clear fire bit</span></span>
<span id="L192" class="line"><span class="nl">no_fire</span></span>
<span id="L193" class="line"></span>
<span id="L194" class="line">                <span class="k">cmp</span><span class="nd">.b </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; up</span></span>
<span id="L195" class="line">                <span class="k">beq</span>     <span class="nv">up</span></span>
<span id="L196" class="line">                <span class="k">cmp</span><span class="nd">.b </span>  <span class="nd">#</span><span class="mi">2</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; down</span></span>
<span id="L197" class="line">                <span class="k">beq</span>     <span class="nv">down</span></span>
<span id="L198" class="line">                <span class="k">cmp</span><span class="nd">.b </span>  <span class="nd">#</span><span class="mi">4</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; left</span></span>
<span id="L199" class="line">                <span class="k">beq</span>     <span class="nv">left</span></span>
<span id="L200" class="line">                <span class="k">cmp</span><span class="nd">.b </span>  <span class="nd">#</span><span class="mi">8</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; right</span></span>
<span id="L201" class="line">                <span class="k">beq</span>     <span class="nv">right</span></span>
<span id="L202" class="line">                <span class="k">cmp</span><span class="nd">.b </span>  <span class="nd">#</span><span class="mi">9</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; up-right</span></span>
<span id="L203" class="line">                <span class="k">beq</span>     <span class="nv">up_right</span></span>
<span id="L204" class="line">                <span class="k">cmp</span><span class="nd">.b </span>  <span class="nd">#</span><span class="mi">10</span><span class="p">,</span> <span class="nb">d0</span>                   <span class="c1">; down-right</span></span>
<span id="L205" class="line">                <span class="k">beq</span>     <span class="nv">down_right</span></span>
<span id="L206" class="line">                <span class="k">cmp</span><span class="nd">.b </span>  <span class="nd">#</span><span class="mi">6</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; down-left</span></span>
<span id="L207" class="line">                <span class="k">beq</span>     <span class="nv">down_left</span></span>
<span id="L208" class="line">                <span class="k">cmp</span><span class="nd">.b </span>  <span class="nd">#</span><span class="mi">5</span><span class="p">,</span> <span class="nb">d0</span>                    <span class="c1">; up-left</span></span>
<span id="L209" class="line">                <span class="k">beq</span>     <span class="nv">up_left</span></span>
<span id="L210" class="line">                <span class="k">bra</span>     <span class="nv">done</span></span>
<span id="L211" class="line"><span class="nl">up</span></span>
<span id="L212" class="line">                <span class="k">sub</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nv">y_coord</span></span>
<span id="L213" class="line">                <span class="k">bra</span>     <span class="nv">done</span></span>
<span id="L214" class="line"><span class="nl">down</span></span>
<span id="L215" class="line">                <span class="k">add</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nv">y_coord</span></span>
<span id="L216" class="line">                <span class="k">bra</span>     <span class="nv">done</span></span>
<span id="L217" class="line"><span class="nl">left</span></span>
<span id="L218" class="line">                <span class="k">sub</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nv">x_coord</span></span>
<span id="L219" class="line">                <span class="k">bra</span>     <span class="nv">done</span></span>
<span id="L220" class="line"><span class="nl">right</span></span>
<span id="L221" class="line">                <span class="k">add</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nv">x_coord</span></span>
<span id="L222" class="line">                <span class="k">bra</span>     <span class="nv">done</span></span>
<span id="L223" class="line"><span class="nl">up_right</span></span>
<span id="L224" class="line">                <span class="k">sub</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nv">y_coord</span></span>
<span id="L225" class="line">                <span class="k">add</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nv">x_coord</span></span>
<span id="L226" class="line">                <span class="k">bra</span>     <span class="nv">done</span></span>
<span id="L227" class="line"><span class="nl">down_right</span></span>
<span id="L228" class="line">                <span class="k">add</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nv">y_coord</span></span>
<span id="L229" class="line">                <span class="k">add</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nv">x_coord</span></span>
<span id="L230" class="line">                <span class="k">bra</span>     <span class="nv">done</span></span>
<span id="L231" class="line"><span class="nl">down_left</span></span>
<span id="L232" class="line">                <span class="k">add</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nv">y_coord</span></span>
<span id="L233" class="line">                <span class="k">sub</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nv">x_coord</span></span>
<span id="L234" class="line">                <span class="k">bra</span>     <span class="nv">done</span></span>
<span id="L235" class="line"><span class="nl">up_left</span></span>
<span id="L236" class="line">                <span class="k">sub</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nv">y_coord</span></span>
<span id="L237" class="line">                <span class="k">sub</span><span class="nd">.w </span>  <span class="nd">#</span><span class="mi">1</span><span class="p">,</span> <span class="nv">x_coord</span></span>
<span id="L238" class="line">                <span class="k">bra</span>     <span class="nv">done</span></span>
<span id="L239" class="line"><span class="nl">done</span></span>
<span id="L240" class="line"></span>
<span id="L241" class="line"><span class="c1">; avoid going outside screen</span></span>
<span id="L242" class="line">                <span class="k">cmp</span>     <span class="nd">#</span><span class="mi">319</span><span class="o">-</span><span class="mi">32</span><span class="p">,</span> <span class="nv">x_coord</span></span>
<span id="L243" class="line">                <span class="k">blt</span>     <span class="nv">x_right_ok</span></span>
<span id="L244" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">319</span><span class="o">-</span><span class="mi">32</span><span class="p">,</span> <span class="nv">x_coord</span></span>
<span id="L245" class="line"><span class="nl">x_right_ok</span></span>
<span id="L246" class="line"></span>
<span id="L247" class="line">                <span class="k">cmp</span>     <span class="nd">#</span><span class="mi">0</span><span class="p">,</span> <span class="nv">x_coord</span></span>
<span id="L248" class="line">                <span class="k">bgt</span>     <span class="nv">x_left_ok</span></span>
<span id="L249" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">0</span><span class="p">,</span> <span class="nv">x_coord</span></span>
<span id="L250" class="line"><span class="nl">x_left_ok</span></span>
<span id="L251" class="line"></span>
<span id="L252" class="line">                <span class="k">cmp</span>     <span class="nd">#</span><span class="mi">199</span><span class="o">-</span><span class="mi">32</span><span class="p">,</span> <span class="nv">y_coord</span></span>
<span id="L253" class="line">                <span class="k">blt</span>     <span class="nv">y_low_ok</span></span>
<span id="L254" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">199</span><span class="o">-</span><span class="mi">32</span><span class="p">,</span> <span class="nv">y_coord</span></span>
<span id="L255" class="line"><span class="nl">y_low_ok</span></span>
<span id="L256" class="line"></span>
<span id="L257" class="line">                <span class="k">cmp</span>     <span class="nd">#</span><span class="mi">0</span><span class="p">,</span> <span class="nv">y_coord</span></span>
<span id="L258" class="line">                <span class="k">bgt</span>     <span class="nv">y_high_ok</span></span>
<span id="L259" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">0</span><span class="p">,</span> <span class="nv">y_coord</span></span>
<span id="L260" class="line"><span class="nl">y_high_ok</span></span>
<span id="L261" class="line">                <span class="k">rts</span></span>
<span id="L262" class="line"></span>
<span id="L263" class="line"></span>
<span id="L264" class="line"><span class="nl">read_joy</span></span>
<span id="L265" class="line"><span class="c1">; executes every time joystick information is changed</span></span>
<span id="L266" class="line">                <span class="k">move</span><span class="nd">.b </span> <span class="mi">1</span><span class="p">(</span><span class="nb">a0</span><span class="p">),</span> <span class="nv">joy</span>                <span class="c1">; store joy 0 data</span></span>
<span id="L267" class="line">                <span class="k">move</span><span class="nd">.b </span> <span class="mi">2</span><span class="p">(</span><span class="nb">a0</span><span class="p">),</span> <span class="nv">joy</span><span class="o">+</span><span class="mi">1</span>              <span class="c1">; store joy 1 data</span></span>
<span id="L268" class="line">                <span class="k">rts</span></span>
<span id="L269" class="line"></span>
<span id="L270" class="line"><span class="nl">apply_mask</span></span>
<span id="L271" class="line"><span class="c1">; applies the mask to the background</span></span>
<span id="L272" class="line">                <span class="k">jsr</span>     <span class="nv">get_coordinates</span></span>
<span id="L273" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">mask</span><span class="p">,</span> <span class="nb">a0</span></span>
<span id="L274" class="line">                <span class="k">mulu</span>    <span class="nd">#</span><span class="mi">768</span><span class="p">,</span> <span class="nb">d0</span>                  <span class="c1">; multiply position with size</span></span>
<span id="L275" class="line">                <span class="k">add</span><span class="nd">.l </span>  <span class="nb">d0</span><span class="p">,</span> <span class="nb">a0</span>                    <span class="c1">; add value to mask pointer</span></span>
<span id="L276" class="line"></span>
<span id="L277" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">32</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d7</span>                 <span class="c1">; mask is 32 scan lines</span></span>
<span id="L278" class="line"><span class="nl">maskloop</span></span>
<span id="L279" class="line">                <span class="kr">rept</span>    <span class="mi">6</span>                         <span class="c1">; mask is 6*4 bytes width</span></span>
<span id="L280" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="nb">d0</span>                 <span class="c1">; mask data in d0</span></span>
<span id="L281" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a1</span><span class="p">),</span> <span class="nb">d1</span>                  <span class="c1">; background data in d1</span></span>
<span id="L282" class="line">                <span class="k">and</span><span class="nd">.l </span>  <span class="nb">d0</span><span class="p">,</span> <span class="nb">d1</span>                    <span class="c1">; and mask and picture data</span></span>
<span id="L283" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nb">d1</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>                 <span class="c1">; move masked picture data to background</span></span>
<span id="L284" class="line">                <span class="kr">endr</span></span>
<span id="L285" class="line">                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">136</span><span class="p">,</span> <span class="nb">a1</span>                  <span class="c1">; next scan line</span></span>
<span id="L286" class="line">                <span class="k">dbf</span>     <span class="nb">d7</span><span class="p">,</span> <span class="nv">maskloop</span></span>
<span id="L287" class="line"></span>
<span id="L288" class="line">                <span class="k">rts</span></span>
<span id="L289" class="line"></span>
<span id="L290" class="line"></span>
<span id="L291" class="line"><span class="nl">put_sprite</span></span>
<span id="L292" class="line"><span class="c1">; paints the sprite to the screen</span></span>
<span id="L293" class="line">                <span class="k">jsr</span>     <span class="nv">get_coordinates</span></span>
<span id="L294" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">sprite</span><span class="p">,</span> <span class="nb">a0</span></span>
<span id="L295" class="line">                <span class="k">mulu</span>    <span class="nd">#</span><span class="mi">768</span><span class="p">,</span> <span class="nb">d0</span>                  <span class="c1">; multiply position with size</span></span>
<span id="L296" class="line">                <span class="k">add</span><span class="nd">.l </span>  <span class="nb">d0</span><span class="p">,</span> <span class="nb">a0</span>                    <span class="c1">; add value to sprite pointer</span></span>
<span id="L297" class="line"></span>
<span id="L298" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">32</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d7</span>                 <span class="c1">; sprite is 32 scan lines</span></span>
<span id="L299" class="line"><span class="nl">bgloop</span></span>
<span id="L300" class="line">                <span class="kr">rept</span>    <span class="mi">6</span>                         <span class="c1">; sprite is 6*4 bytes width</span></span>
<span id="L301" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="nb">d0</span>                 <span class="c1">; sprite data in d0</span></span>
<span id="L302" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a1</span><span class="p">),</span> <span class="nb">d1</span>                  <span class="c1">; background data in d1</span></span>
<span id="L303" class="line">                <span class="k">or</span><span class="nd">.l </span>   <span class="nb">d0</span><span class="p">,</span> <span class="nb">d1</span>                    <span class="c1">; or sprite and background data</span></span>
<span id="L304" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nb">d1</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>                 <span class="c1">; move ored sprite data to background</span></span>
<span id="L305" class="line">                <span class="kr">endr</span></span>
<span id="L306" class="line">                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">136</span><span class="p">,</span> <span class="nb">a1</span></span>
<span id="L307" class="line">                <span class="k">dbf</span>     <span class="nb">d7</span><span class="p">,</span> <span class="nv">bgloop</span></span>
<span id="L308" class="line"></span>
<span id="L309" class="line">                <span class="k">rts</span></span>
<span id="L310" class="line"></span>
<span id="L311" class="line"></span>
<span id="L312" class="line"><span class="nl">save_background</span></span>
<span id="L313" class="line"><span class="c1">; saves the background into bgsave</span></span>
<span id="L314" class="line">                <span class="k">jsr</span>     <span class="nv">get_coordinates</span></span>
<span id="L315" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">bgsave</span><span class="p">,</span> <span class="nb">a0</span></span>
<span id="L316" class="line"></span>
<span id="L317" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">32</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d7</span>                 <span class="c1">; sprite is 32 scan lines</span></span>
<span id="L318" class="line"><span class="nl">bgsaveloop</span></span>
<span id="L319" class="line">                <span class="kr">rept</span>    <span class="mi">6</span>                         <span class="c1">; sprite is 6*4 bytes width</span></span>
<span id="L320" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span>              <span class="c1">; copy background to save buffer</span></span>
<span id="L321" class="line">                <span class="kr">endr</span></span>
<span id="L322" class="line">                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">136</span><span class="p">,</span> <span class="nb">a1</span>                  <span class="c1">; next scan line</span></span>
<span id="L323" class="line">                <span class="k">dbf</span>     <span class="nb">d7</span><span class="p">,</span> <span class="nv">bgsaveloop</span></span>
<span id="L324" class="line"></span>
<span id="L325" class="line">                <span class="k">rts</span></span>
<span id="L326" class="line"></span>
<span id="L327" class="line"></span>
<span id="L328" class="line"><span class="nl">restore_background</span></span>
<span id="L329" class="line"><span class="c1">; restores the background using data from bgsave</span></span>
<span id="L330" class="line">                <span class="k">jsr</span>     <span class="nv">get_coordinates</span></span>
<span id="L331" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="nv">bgsave</span><span class="p">,</span> <span class="nb">a0</span></span>
<span id="L332" class="line"></span>
<span id="L333" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="nd">#</span><span class="mi">32</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">d7</span>                 <span class="c1">; sprite is 32 scan lines</span></span>
<span id="L334" class="line"><span class="nl">bgrestoreloop</span></span>
<span id="L335" class="line">                <span class="kr">rept</span>    <span class="mi">6</span>                         <span class="c1">; sprite is 6*4 bytes width</span></span>
<span id="L336" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="p">(</span><span class="nb">a0</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="p">(</span><span class="nb">a1</span><span class="p">)</span><span class="o">+</span>              <span class="c1">; copy save buffer to background</span></span>
<span id="L337" class="line">                <span class="kr">endr</span></span>
<span id="L338" class="line">                <span class="k">add</span><span class="nd">.l </span>  <span class="nd">#</span><span class="mi">136</span><span class="p">,</span> <span class="nb">a1</span>                  <span class="c1">; next scan line</span></span>
<span id="L339" class="line">                <span class="k">dbf</span>     <span class="nb">d7</span><span class="p">,</span> <span class="nv">bgrestoreloop</span></span>
<span id="L340" class="line"></span>
<span id="L341" class="line">                <span class="k">rts</span></span>
<span id="L342" class="line"></span>
<span id="L343" class="line"></span>
<span id="L344" class="line"><span class="nl">get_coordinates</span></span>
<span id="L345" class="line"><span class="c1">; makes a1 point to correct place on screen</span></span>
<span id="L346" class="line"><span class="c1">; sprite position in d0.b</span></span>
<span id="L347" class="line">                <span class="k">move</span><span class="nd">.l </span> <span class="mh">$44e</span><span class="p">,</span> <span class="nb">a1</span>                  <span class="c1">; screen memory in a1</span></span>
<span id="L348" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nv">y_coord</span><span class="p">,</span> <span class="nb">d0</span>               <span class="c1">; put y coordinate in d0</span></span>
<span id="L349" class="line">                <span class="k">mulu</span>    <span class="nd">#</span><span class="mi">160</span><span class="p">,</span> <span class="nb">d0</span>                  <span class="c1">; 160 bytes to a scan line</span></span>
<span id="L350" class="line">                <span class="k">add</span><span class="nd">.l </span>  <span class="nb">d0</span><span class="p">,</span> <span class="nb">a1</span>                    <span class="c1">; add to screen pointer</span></span>
<span id="L351" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nv">x_coord</span><span class="p">,</span> <span class="nb">d0</span>               <span class="c1">; put x coordinate in d0</span></span>
<span id="L352" class="line">                <span class="k">divu</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">16</span><span class="p">,</span> <span class="nb">d0</span>                   <span class="c1">; number of clusters in low, bit in high</span></span>
<span id="L353" class="line">                <span class="k">clr</span><span class="nd">.l </span>  <span class="nb">d1</span>                        <span class="c1">; clear d1</span></span>
<span id="L354" class="line">                <span class="k">move</span><span class="nd">.w </span> <span class="nb">d0</span><span class="p">,</span> <span class="nb">d1</span>                    <span class="c1">; move cluster part to d1</span></span>
<span id="L355" class="line">                <span class="k">mulu</span><span class="nd">.w </span> <span class="nd">#</span><span class="mi">8</span><span class="p">,</span> <span class="nb">d1</span>                    <span class="c1">; 8 bytes to a cluster</span></span>
<span id="L356" class="line">                <span class="k">add</span><span class="nd">.l </span>  <span class="nb">d1</span><span class="p">,</span> <span class="nb">a1</span>                    <span class="c1">; add cluster part to screen memory</span></span>
<span id="L357" class="line">                <span class="k">clr</span><span class="nd">.w </span>  <span class="nb">d0</span>                        <span class="c1">; clear out the cluster value</span></span>
<span id="L358" class="line">                <span class="k">swap</span>    <span class="nb">d0</span>                        <span class="c1">; bit to alter in low part of d0</span></span>
<span id="L359" class="line"></span>
<span id="L360" class="line">                <span class="k">rts</span></span>
<span id="L361" class="line"></span>
<span id="L362" class="line"></span>
<span id="L363" class="line">                <span class="kr">include</span> <span class="nv">initlib</span><span class="nd">.s</span></span>
<span id="L364" class="line"></span>
<span id="L365" class="line"></span>
<span id="L366" class="line">                <span class="kr">section</span> <span class="nv">data</span></span>
<span id="L367" class="line"><span class="nl">x_coord</span>         <span class="kt">dc</span><span class="nd">.w </span>   <span class="mi">150</span></span>
<span id="L368" class="line"><span class="nl">y_coord</span>         <span class="kt">dc</span><span class="nd">.w </span>   <span class="mi">80</span></span>
<span id="L369" class="line"></span>
<span id="L370" class="line"><span class="nl">spr_dat</span>         <span class="kr">incbin</span>  <span class="nv">ship</span><span class="p">.</span><span class="nv">pi1</span></span>
<span id="L371" class="line"><span class="nl">bg</span>              <span class="kr">incbin</span>  <span class="nv">xenon</span><span class="p">.</span><span class="nv">pi1</span></span>
<span id="L372" class="line"><span class="nl">old_70</span>          <span class="kt">dc</span><span class="nd">.l </span>   <span class="mi">0</span></span>
<span id="L373" class="line"></span>
<span id="L374" class="line"><span class="nl">joy_on</span>          <span class="kt">dc</span><span class="nd">.b </span>   <span class="mh">$14</span></span>
<span id="L375" class="line"><span class="nl">mus_on</span>          <span class="kt">dc</span><span class="nd">.b </span>   <span class="mh">$08</span></span>
<span id="L376" class="line"><span class="nl">ikbd_vec</span>        <span class="kt">dc</span><span class="nd">.l </span>   <span class="mi">0</span></span>
<span id="L377" class="line"><span class="nl">old_joy</span>         <span class="kt">dc</span><span class="nd">.l </span>   <span class="mi">0</span></span>
<span id="L378" class="line"></span>
<span id="L379" class="line"></span>
<span id="L380" class="line">                <span class="kr">section</span> <span class="nv">bss</span></span>
<span id="L381" class="line"><span class="nl">sprite</span>          <span class="kt">ds</span><span class="nd">.l </span>   <span class="mi">3072</span>                      <span class="c1">; 32/2+8*32 bytes * 16 positions / 4 for long</span></span>
<span id="L382" class="line"><span class="nl">mask</span>            <span class="kt">ds</span><span class="nd">.l </span>   <span class="mi">3072</span>                      <span class="c1">; same as above</span></span>
<span id="L383" class="line"><span class="nl">bgsave</span>          <span class="kt">ds</span><span class="nd">.l </span>   <span class="mi">192</span>                       <span class="c1">; 2/2+8*32 bytes / 4 for long</span></span>
<span id="L384" class="line"><span class="nl">joy</span>             <span class="kt">ds</span><span class="nd">.b </span>   <span class="mi">2</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Yup, another long source code. There are big similarities between the sprite tutorial though,
since we&#8217;re basically doing the same thing. The new things are of course the joystick on and
off, which are located between the "; joy code" comments, after the pre-shiftings. Nothing to
say there that hasn&#8217;t been said before. Same with the joystick routine. The <code>move_sprite</code>
routine is all new and deserves attention.</p>
</div>
<div class="paragraph">
<p>It begins by moving the joystick data to <code>d0</code>. In this case, I only check joystick 1. First I begin
by checking for the fire button, this is done by seeing if <code>d0</code> contains a number larger than or
equal to 128. If the fire button is pressed, the 8th bit (bit 7, start counting from 0 and from
the rightmost bit) in the joystick status byte is set which means that the byte will hold a value
equal to or higher than 128, since <code>%10000000</code> = 128. Then I clear out the fire bit so that it
won&#8217;t bother me anymore.</p>
</div>
<div class="paragraph">
<p>Next I check for joystick movement. This is done by using the same method as above. For
example, if the joystick is down-left, then bit 1 and 2 are set, meaning the byte will hold
value <code>%00000110</code> = 6. This is the reason for clearing out the fire bit above. If it hadn&#8217;t been
cleared, the number would be either 6 or 128 + 6 = 134 for down-right. So just run through
all 8 directional checks to see if any bits are set, if they are not, I just branch right away to
done. If this branch hadn&#8217;t been there, the program would just continue and execute the
code associated with joystick up if the joystick wasn&#8217;t moved at all. An early bug that caused
me some confusion.</p>
</div>
<div class="paragraph">
<p>After the coordinates have been changed accordingly, I also check to see that the sprite isn&#8217;t
out of bounds, since this could cause a crash and be generally stupid in all kinds of ways. So
just check if the coordinates are right, and if they&#8217;re not, reset them to the closest correct
value. If you want a speedier ship, just increase the speed accordingly, adding more than one
to the coordinates, and also remember to include this in the boundary check, just as the
sprite.</p>
</div>
<div class="paragraph">
<p>Some of you will probably notice that the ship itself is not 32 scan lines, although I treat the
sprite as such. This has the effect of the ship never reaching all the way down the screen,
since there is some black space worth of sprite data. This could be easily fixed of course, but
I didn&#8217;t. Also, two ships moving might be nice, at first I considered having both the Xenon 2
ship and the Xenon 1 ship side by side, controlled by two joysticks, but I decided to keep it
simple. However, there should be no big trouble incorporating that, and changing the fire
button perhaps to morph the Xenon 1 ship.</p>
</div>
<div class="paragraph">
<p>Having two sprites is no harder than having one sprite, the only thing you have to think about
is the order of painting the sprites, the ones painted first will be painted over by the ones that
come next. Yet another cool thing is to change the look of the sprite as you move it, like in
the real Xenon game, they have the ship tilted sideways and generate rocket fire when it
moves, all you need is a flag to know which state the ship is in and change the sprite address
accordingly.</p>
</div>
<div class="paragraph">
<p>This means having a sprite picture with not just one ship, but the ship tilted in directions and
with rocket flames, all in all lots of pictures. All of these sprites will of course fit in one degas
picture, so all you need is the correct offset into this picture depending on what "mode" the
sprite is in. Compare this to the way we address the sprite mask, only in this case it&#8217;s a
different sprite (or different look of the sprite, depending on how you see it).</p>
</div>
<div class="paragraph">
<p>Now you have the tools needed to create a game, or even a demo for that matter: now go to
it! Even though there is still much to learn, the basics have been covered, all but one thing:
music and sound. It is my hope that this will come soon. But you don&#8217;t have to worry about
that for now, code away and the music will be easily incorporated at a later stage.</p>
</div>
<div class="paragraph">
<p>Usually, you just hook up the music in your VBL routine. On the Dead Hackers Society page,
<a href="http://dhs.nu/" class="bare">http://dhs.nu/</a>, there are two chip editors (at least) with instructions on how to play the
generated music in assembler: Edsynth and the XLR8. Go take a look at them if you&#8217;re
curious, there should be no trouble understanding the code.</p>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2018-11-12 00:02:07 UTC
</div>
</div>
</body>
</html>